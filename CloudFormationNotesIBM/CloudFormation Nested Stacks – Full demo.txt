CloudFormation Nested Stacks â€“ Full Console Lab

This lab will deploy:

Parent Stack
VPC Nested Stack
Compute Nested Stack

You will clearly see how:
Nested stacks appear in console
Outputs flow from child â†’ parent â†’ child
Updates & deletes work

ğŸ“ LAB STRUCTURE

You will create three files:

main.yaml          (Parent template)
vpc.yaml           (Child template 1)
compute.yaml       (Child template 2)

ğŸ¥‡ PART 1 â€” Upload Child Templates to S3
Step 1: Go to S3 console â†’ create a bucket

Example bucket name:

cf-nested-demo-<yourname>


Enable:
âœ”ï¸ Block Public Access (default)
âŒ No need for versioning
âœ”ï¸ Keep everything default

Step 2: Upload these two files to S3
vpc.yaml
compute.yaml


Inside a folder (optional):

templates/vpc.yaml
templates/compute.yaml

ğŸ¥ˆ PART 2 â€” Use Regional S3 URLs

Copy the Object URLs:

Example:

https://cf-nested-demo-ujwal.s3.ap-south-1.amazonaws.com/templates/vpc.yaml
https://cf-nested-demo-ujwal.s3.ap-south-1.amazonaws.com/templates/compute.yaml


Replace these URLs inside the parent template.

ğŸ¥‰ PART 3 â€” Create the Parent Template
main.yaml (Parent Stack)

ğŸ¯ Paste this EXACT template in console:

AWSTemplateFormatVersion: '2010-09-09'
Description: Parent stack demonstrating nested stacks

Parameters:
  EnvName:
    Type: String
    Default: dev

Resources:

  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://YOUR-BUCKET.s3.ap-south-1.amazonaws.com/templates/vpc.yaml
      Parameters:
        EnvName: !Ref EnvName

  ComputeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://YOUR-BUCKET.s3.ap-south-1.amazonaws.com/templates/compute.yaml
      Parameters:
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        PublicSubnet1: !GetAtt NetworkStack.Outputs.PublicSubnet1
        PublicSubnet2: !GetAtt NetworkStack.Outputs.PublicSubnet2
        EnvName: !Ref EnvName


ğŸ‘‰ Replace YOUR-BUCKET and region with your actual bucket name.

ğŸ§± PART 4 â€” Child Template 1: vpc.yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: VPC Nested Stack

Parameters:
  EnvName:
    Type: String

Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      Tags:
        - Key: Name
          Value: !Sub "${EnvName}-vpc"

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub "${EnvName}-subnet1"

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub "${EnvName}-subnet2"

Outputs:
  VpcId:
    Value: !Ref MyVPC
  PublicSubnet1:
    Value: !Ref PublicSubnet1
  PublicSubnet2:
    Value: !Ref PublicSubnet2

ğŸ–¥ï¸ PART 5 â€” Child Template 2: compute.yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: Compute Nested Stack

Parameters:
  EnvName:
    Type: String
  VpcId:
    Type: String
  PublicSubnet1:
    Type: String
  PublicSubnet2:
    Type: String

Resources:
  InstanceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

  MyEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0e2ff28bfb72a4e45   # Amazon Linux 2023 (Mumbai region)
      SubnetId: !Ref PublicSubnet1

ğŸ§ª PART 6 â€” Deploy the Parent Stack in AWS Console
Steps:

Go to CloudFormation Console

Click Create stack â†’ With new resources

Under â€œSpecify templateâ€, choose Upload a template file

Upload main.yaml

Next â†’ Enter a stack name:

nested-demo


Keep parameters default (EnvName = dev)

Click Create Stack

ğŸ” PART 7 â€” Observe the Nested Stacks

Inside CloudFormation console:

In the Stacks List, you will see:

nested-demo (parent)

nested-demo-NetworkStack-XXXX (child)

nested-demo-ComputeStack-XXXX (child)

Go to Resources tab of parent:

You will see:

NetworkStack (AWS::CloudFormation::Stack)

ComputeStack (AWS::CloudFormation::Stack)

Expand them:

See VPC + subnets from child 1

See EC2 + SG from child 2

ğŸ§© PART 8 â€” Verify Outputs Are Passed

Go to the NetworkStack â†’ Outputs
You will see:

VpcId
PublicSubnet1
PublicSubnet2


Go to parent â†’ Resources â†’ ComputeStack
And verify these outputs are being used.

ğŸ—‘ï¸ PART 9 â€” Clean Up

Delete the parent stack:

CloudFormation will:
âœ”ï¸ Delete compute nested stack
âœ”ï¸ Delete VPC nested stack
âœ”ï¸ Delete all VPC resources
âœ”ï¸ Delete EC2 & SG resources

You DO NOT need to delete child stacks manually.