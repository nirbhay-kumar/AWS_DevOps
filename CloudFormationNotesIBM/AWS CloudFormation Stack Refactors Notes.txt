AWS CloudFormation: Stack Refactors

Stack refactoring is the process of reorganizing, modularizing, or optimizing your CloudFormation stacks without changing the actual deployed resources’ behavior.

This is a common practice in large environments to make stacks maintainable, reusable, and easier to manage.

1️⃣ Why Refactor CloudFormation Stacks?

Simplify large stacks that have too many resources

Enable reusability via nested stacks or modules

Improve maintainability and reduce human errors

Separate responsibilities (e.g., network, compute, storage)

Support CI/CD deployments efficiently

2️⃣ Refactoring Techniques
A. Use Nested Stacks

Break a monolithic stack into smaller stacks and call them using AWS::CloudFormation::Stack.

Example:

Parent stack: “ApplicationStack”

Child stacks: “VPCStack”, “EC2Stack”, “RDSStack”

Benefits: easier updates, modular templates, independent updates for child stacks.

B. Use Parameters and Outputs

Refactor by parameterizing reusable resources instead of hardcoding values.

Use Outputs in one stack and Imports in another:

Example: VPC stack exports VPCId → EC2 stack imports VPCId

C. Use Macros / Transform Functions

Use AWS::Include to import common sections of templates.

Example: common IAM policies, security groups.

Allows central maintenance of shared resources.

D. Split Resources by Lifecycle

Group resources that have different update frequencies into separate stacks.

Example:

Network stack (rarely changes)

Application stack (frequent updates)

Reduces risk of accidental resource replacement.

E. Convert to CloudFormation Modules (Recommended)

CloudFormation Modules allow packaging resources as reusable units.

Example: a module for EC2 + SecurityGroup + IAM role

Modules can be versioned, published, and reused across stacks.

3️⃣ Example: Refactor Monolithic Stack

Monolithic Stack (Before)

Resources:
  MyVPC:
    Type: AWS::EC2::VPC
  MySubnet:
    Type: AWS::EC2::Subnet
  MyEC2:
    Type: AWS::EC2::Instance


Refactored with Nested Stacks (After)

Parent Stack:

Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/templates/vpc.yaml
      Parameters:
        VPCName: "MyVPC"

  AppStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/templates/app.yaml
      Parameters:
        VPCId: !GetAtt VPCStack.Outputs.VPCId


Child Stack (vpc.yaml)

Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16

Outputs:
  VPCId:
    Value: !Ref MyVPC

4️⃣ Best Practices for Stack Refactoring

Use nested stacks for logical separation

Use Outputs/Exports for dependencies

Keep stack sizes manageable (<500 resources per stack)

Version your modules/templates for safe reuse

Avoid circular dependencies between stacks

Test changes in a sandbox environment first