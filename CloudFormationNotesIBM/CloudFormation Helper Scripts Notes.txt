‚úÖ What Are CloudFormation Helper Scripts?

These are Linux-based helper binaries installed via the CloudFormation EC2 bootstrap package:

yum install -y aws-cfn-bootstrap   (Amazon Linux 2)


They allow CloudFormation to:

Configure EC2 during launch

Fetch metadata from the template

Install packages / write files

Start services

Signal success/failure

Detect configuration changes

üü¶ 1. cfn-init

Purpose:
Reads AWS::CloudFormation::Init metadata and applies:

Install packages

Create users

Create files

Download sources

Start services

Run commands

Usage inside UserData:

/opt/aws/bin/cfn-init -v \
  --stack ${AWS::StackName} \
  --resource EC2Instance \
  --region ${AWS::Region}

üü© 2. cfn-signal

Purpose:
Sends a success or failure signal back to CloudFormation.

Used with:

CreationPolicy

WaitCondition

Example:

/opt/aws/bin/cfn-signal -e $? \
  --stack ${AWS::StackName} \
  --resource EC2Instance \
  --region ${AWS::Region}


If EC2 initialization fails ‚Üí CloudFormation rolls back the stack

Prevents ‚ÄúEC2 launched but service not running‚Äù scenarios

üüß 3. cfn-get-metadata

Purpose:
Fetches and prints AWS::CloudFormation::Init metadata.

Useful for debugging.

Example:

/opt/aws/bin/cfn-get-metadata \
  --stack my-stack \
  --resource EC2Instance \
  --region us-east-1


Shows exactly what cfn-init will run.

üü• 4. cfn-hup

Purpose:
Daemon that watches for changes in metadata and reruns cfn-init automatically.

Use when you want:

Auto-update configuration

Auto-reload app when metadata changes

Apply patch updates without recreating EC2 instance

Runs as a background service.

üß© How They Work Together
CloudFormation Metadata  ‚Üí  cfn-init
                              ‚Üì
                         Install packages, files, services
                              ‚Üì
                         cfn-signal ‚Üí tells CFN success/failure


For continuous updates:

cfn-hup ‚Üí detects metadata change ‚Üí calls cfn-init again


‚úÖ Full CloudFormation Demo Using ALL Helper Scripts
üéØ What this demo does

When you deploy the stack:

EC2 instance launches

cfn-init installs Apache, writes an HTML file

cfn-signal tells CloudFormation: ‚ÄúInstance setup completed!‚Äù

cfn-hup daemon runs and watches metadata

When you update metadata ‚Üí cfn-hup automatically re-runs cfn-init

cfn-get-metadata lets you print the metadata from inside the instance

‚úÖ 1. Full CloudFormation Template (Copy‚ÄìPaste Ready)

Save the file as demo-helper-scripts.yaml

AWSTemplateFormatVersion: 2010-09-09
Description: Fully working CFN Init + CFN HUP auto update demo

Parameters:
  WebContentVersion:
    Type: String
    Default: "v1"
    Description: Increase version number to trigger cfn-hup

Resources:

  DemoInstance:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
          files:
            "/var/www/html/index.html":
              content: !Sub |
                <h1>CloudFormation cfn-init & cfn-hup Demo</h1>
                <p>Updated Content Version: ${WebContentVersion}</p>
              mode: '000644'
              owner: root
              group: root

            "/etc/cfn/cfn-hup.conf":
              content: !Sub |
                [main]
                stack=${AWS::StackId}
                region=${AWS::Region}
                interval=2
              mode: '000400'
              owner: root
              group: root

            "/etc/cfn/hooks.d/cfn-auto-reloader.conf":
              content: !Sub |
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.DemoInstance.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource DemoInstance --region ${AWS::Region}
                runas=root
              mode: '000400'
              owner: root
              group: root

          services:
            sysvinit:
              httpd:
                enabled: true
                ensureRunning: true

              cfn-hup:
                enabled: true
                ensureRunning: true
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf


    Properties:
      InstanceType: t2.micro
      ImageId: ami-0c2b8ca1dad447f8a  # Amazon Linux 2 (modify if needed)
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum install -y aws-cfn-bootstrap

          /opt/aws/bin/cfn-init -v \
            --stack ${AWS::StackName} \
            --resource DemoInstance \
            --region ${AWS::Region}

          /opt/aws/bin/cfn-signal -e $? \
            --stack ${AWS::StackName} \
            --resource DemoInstance \
            --region ${AWS::Region}

    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT10M


‚úÖ 2. Deploy the stack

From AWS Console ‚Üí CloudFormation ‚Üí Create stack ‚Üí Upload template ‚Üí Provide KeyPair

Or using CLI:

aws cloudformation deploy \
  --template-file demo-helper-scripts.yaml \
  --stack-name DemoHelperScripts \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides KeyName=UjwalKeyPairdemo


STACK WILL BE "CREATE_IN_PROGRESS" until cfn-signal succeeds.

‚úÖ 3. Validate it worked

SSH into instance:

ssh -i UjwalKeyPairdemo ec2-user@<public-ip>


Check Apache is running:

systemctl status httpd


Open browser ‚Üí http://<public-ip>
You should see:

Hello from CloudFormation cfn-init! (Version 1)

‚úÖ 4. Use cfn-get-metadata

Inside EC2 instance:

/opt/aws/bin/cfn-get-metadata \
  --stack DemoHelperScripts \
  --resource DemoInstance \
  --region us-east-1


This prints EXACT metadata delivered to instance.

‚úÖ 5. Test cfn-hup Auto-Reload Feature

Now modify metadata to simulate an update.

Step 1 ‚Äî Update HTML Version in template

Change:

<p>Version 1</p>


to:

<p>Version 2</p>


Save file ‚Üí redeploy:

aws cloudformation deploy \
  --template-file demo-helper-scripts.yaml \
  --stack-name DemoHelperScripts

Step 2 ‚Äî cfn-hup detects change automatically

Inside EC2, check logs:

cat /var/log/cfn-hup.log


You will see:

Detected metadata change, invoking cfn-init

Step 3 ‚Äî Open browser again

Reload:

Version 2


üéâ cfn-hup auto-reloaded changes WITHOUT terminating instance.

üü¶ Summary of What You Learned
Helper Script			Purpose
cfn-init			Install software, write files, run commands
cfn-signal			Notify CloudFormation that instance is ready
cfn-get-metadata		View CloudFormation metadata from inside instance
cfn-hup	Automatically 		detect metadata updates and re-run cfn-init